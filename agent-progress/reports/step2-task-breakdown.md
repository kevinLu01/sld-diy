# Step2 任务拆分与开发排期

## 0. 执行原则
- 先 P0 后 P1/P2。
- 每个任务都必须包含：设计评审 -> 开发 -> 回归 -> 文档更新。
- 所有接口变更必须同步 API 文档与回归脚本。

## 1. Epic 列表

### Epic A（P0）数据模型单轨化
1. A1 现网读写路径盘点（设计）
- 输出: 表-模块映射清单（哪些接口读写 `t_*`，哪些读写 CamelCase）。
- 验收: 覆盖 auth/user/cart/order/diy/admin 6大模块。

2. A2 目标模型确认（设计）
- 输出: 统一到 `t_*` 的字段对照表、废弃字段清单。
- 验收: DBA 与后端评审通过。

3. A3 迁移脚本与回滚脚本（开发）
- 输出: `Vxxx__unify_tables.sql` + `rollback.sql`。
- 验收: 在预发环境迁移成功且可回滚。

4. A4 代码切换与旧表读写下线（开发）
- 输出: Mapper/Entity/Service 全量切换到 `t_*`。
- 验收: 全链路回归通过，日志无旧表 SQL。

5. A5 数据一致性核对（测试）
- 输出: 关键表行数/抽样记录一致性报告。
- 验收: 核对报告无阻塞差异。

### Epic B（P0）统一当前用户解析
1. B1 `@CurrentUserId` 注解与参数解析器（开发）
- 输出: 通用解析组件，替代控制器内 `resolveUserId`。
- 验收: auth/user/diy/service/solution/order/cart 全部迁移。

2. B2 鉴权失败错误语义统一（开发）
- 输出: 未登录/无权限统一错误码与消息。
- 验收: 前端可稳定识别 401/403。

3. B3 控制器重构回归（测试）
- 输出: 回归脚本 + 报告。
- 验收: 不再出现 `MissingRequestHeaderException`。

### Epic C（P0）契约测试与关键链路集成测试
1. C1 契约基线生成（设计/开发）
- 输出: admin/user/diy/order 契约样例（request/response schema）。
- 验收: CI 中可执行。

2. C2 关键写链路集成测试（开发）
- 输出: 注册->DIY->购物车->下单->后台CRUD 自动化测试。
- 验收: PR 阶段必须通过。

3. C3 回归数据隔离策略（设计）
- 输出: 测试数据命名规范与清理策略。
- 验收: 不污染生产关键数据。

### Epic D（P1）DIY 方案发布闭环
1. D1 方案发布门禁规则（设计）
- 规则: 发布前必须有 BOM 主件/辅件，兼容校验通过。
- 验收: 规则文档与错误码定义完成。

2. D2 后台发布校验实现（开发）
- 输出: 发布接口前置校验。
- 验收: 空方案无法发布。

3. D3 前台提示与阻断（开发）
- 输出: 下单前显示“缺失配件/不兼容原因”。
- 验收: 失败有可读提示。

### Epic E（P1）服务工单状态机
1. E1 状态流转设计（设计）
- 状态: pending -> processing -> completed -> closed。
- 验收: 状态图与权限矩阵确认。

2. E2 后台操作与API（开发）
- 输出: 状态更新接口 + 后台按钮。
- 验收: completed 后才允许评价。

3. E3 通知与审计（开发）
- 输出: 状态变更记录与用户可见历史。
- 验收: 可追溯责任人和时间。

### Epic F（P1）后台 CRUD 可观测性
1. F1 操作日志模型（设计）
- 输出: `operator/action/entity/diff/at` 字段模型。
- 验收: 可覆盖主要后台资源。

2. F2 日志写入与查询（开发）
- 输出: 写入拦截器/服务封装 + 列表接口。
- 验收: 主要 CRUD 都有日志。

3. F3 后台“最近变更”面板（前端）
- 输出: dashboard 展示最近变更。
- 验收: 可按模块过滤。

### Epic G（P2）DIY 推荐可解释性
1. G1 规则解释模型（设计）
- 输出: 命中规则、评分分项、替代建议模型。

2. G2 推荐接口增强（开发）
- 输出: `explanations` 字段。

3. G3 前台解释UI（前端）
- 输出: 推荐详情“为什么推荐/为什么不兼容”。

### Epic H（P0）手机端适配（响应式与可用性）
1. H1 移动端设计规范（设计）
- 输出: 断点规范（<=768, <=480）、导航与关键页面布局稿。
- 验收: 首页/产品/DIY/购物车/下单/个人中心均有移动稿。

2. H2 前台响应式改造（前端）
- 输出: Header、列表、表单、步骤流在手机端可操作。
- 验收: iPhone/Android 主流视口无溢出、无遮挡、无关键按钮不可点。

3. H3 移动端专项回归（测试）
- 输出: 手机端点击流回归报告与截图。
- 验收: 注册->DIY->下单主链路可完成。

### Epic I（P1）微信登录接入
1. I1 登录方案设计（设计）
- 输出: 微信 OAuth2/扫码登录方案、账号绑定策略、新老账号合并规则。
- 验收: 明确 unionid/openid 存储、token 签发与风控策略。

2. I2 后端接入实现（开发）
- 输出: `/api/v1/auth/wechat/*`（授权回调、绑定、登录）及用户表扩展字段。
- 验收: 微信授权后可签发本系统 JWT 并拉取用户资料。

3. I3 前端登录入口与回调页（前端）
- 输出: 登录页新增“微信登录”，支持 H5 跳转与回调处理。
- 验收: 正常登录、取消授权、授权失败三路径均可控。

4. I4 联调与安全校验（测试）
- 输出: 防重放、防 CSRF state、过期 code 处理报告。
- 验收: 安全测试通过，异常场景有明确提示。

## 2. Sprint 划分

### Sprint 1（本周，P0）
- A1 A2 A3（完成设计与迁移脚本）
- B1 B2（统一用户解析）
- C1 C2（契约与关键链路测试入 CI）
- H1（手机端规范）

### Sprint 2（下周，P1）
- A4 A5（模型切换和一致性核对）
- D1 D2 D3（方案发布闭环）
- E1 E2（工单状态机）
- H2 H3（手机端改造与回归）
- I1（微信登录方案设计）

### Sprint 3（第三周，P1/P2）
- E3 F1 F2 F3
- G1 G2 G3
- I2 I3 I4（微信登录开发联调）

## 3. 角色分工建议
- 你（产品/业务Owner）: 规则确认、优先级裁决、验收口径。
- 后端负责人: A/B/C/D/E/F 后端任务。
- 前端负责人: D3/F3/G3。
- 测试负责人: C2 + 全链路回归 + 生产观测。

## 4. 本周立即启动任务（可当天开工）
1. 建立 `CurrentUserResolver`（B1）。
2. 建立契约测试目录和第一批 schema（C1）。
3. 产出双表读写盘点表（A1）。
4. 产出迁移SQL草案（A3）。
