name: Deploy Java Backend

on:
  push:
    branches:
      - main
    paths:
      - 'sld-diy-java/**'
      - '.github/workflows/deploy-java.yml'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•'
        required: false
        default: false
        type: boolean

jobs:
  build-and-test:
    name: Build and Test Java Backend
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ”¨ Build with Maven
        working-directory: ./sld-diy-java
        run: |
          echo "å¼€å§‹æ„å»º Java åç«¯..."
          mvn clean package -DskipTests -B
          echo "âœ… æ„å»ºå®Œæˆ"

      - name: ğŸ§ª Run Tests
        if: ${{ !inputs.skip_tests }}
        working-directory: ./sld-diy-java
        run: |
          echo "è¿è¡Œæµ‹è¯•..."
          mvn test -B || echo "âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œç»§ç»­éƒ¨ç½²"
          echo "âœ… æµ‹è¯•å®Œæˆ"

      - name: ğŸ“¦ Upload JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: sld-diy-java/target/*.jar
          retention-days: 7

      - name: ğŸ“‹ Build Summary
        run: |
          echo "## ğŸ‰ Java åç«¯æ„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Java ç‰ˆæœ¬: 17" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ„å»ºæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Deploy to Server
    needs: build-and-test
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "================================"
            echo "ğŸš€ å¼€å§‹éƒ¨ç½² Java åç«¯"
            echo "================================"

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /var/www/sld-diy

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git config --global --add safe.directory /var/www/sld-diy
            git pull origin main

            # å¤‡ä»½å½“å‰è¿è¡Œçš„å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if docker ps -a --format '{{.Names}}' | grep -q 'backend-java'; then
              echo "ğŸ’¾ å¤‡ä»½å½“å‰å®¹å™¨..."
              docker commit $(docker ps -aq -f name=backend-java) sld-diy-backend-java:backup-$(date +%Y%m%d_%H%M%S) || true
            fi

            # ä½¿ç”¨ docker compose é‡å»ºå¹¶å¯åŠ¨ Java åç«¯
            echo "ğŸ”¨ æ„å»ºå¹¶å¯åŠ¨ Java åç«¯..."
            docker compose up -d --build backend-java

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 30

            # å¥åº·æ£€æŸ¥
            echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            MAX_RETRIES=10
            RETRY=0

            while [ $RETRY -lt $MAX_RETRIES ]; do
              if curl -f -s http://localhost:9002/api/v1/health; then
                echo ""
                echo "âœ… Java åç«¯å¥åº·æ£€æŸ¥é€šè¿‡"
                break
              fi
              RETRY=$((RETRY + 1))
              if [ $RETRY -lt $MAX_RETRIES ]; then
                echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($RETRY/$MAX_RETRIES)"
                sleep 5
              else
                echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—:"
                docker compose logs --tail=50 backend-java
                exit 1
              fi
            done

            # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
            echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
            docker compose ps backend-java

            echo "================================"
            echo "âœ… Java åç«¯éƒ¨ç½²æˆåŠŸ"
            echo "================================"

      - name: ğŸ¥ Extended Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸ¥ æ‰©å±•å¥åº·æ£€æŸ¥..."
            curl -f http://localhost:9002/api/v1/health || exit 1
            echo "âœ… Java åç«¯å¥åº·"
            curl -f http://localhost:9002/doc.html || echo "âš ï¸ Swagger æ–‡æ¡£æš‚æ—¶æ— æ³•è®¿é—®"
            echo "âœ… æ‰©å±•å¥åº·æ£€æŸ¥å®Œæˆ"

