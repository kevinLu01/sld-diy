name: Deploy Frontend

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'nginx/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  deploy-frontend:
    name: Deploy Frontend to Server
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # 2. è®¾ç½®Node.jsçŽ¯å¢ƒ
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # 3. å®‰è£…ä¾èµ–
      - name: ðŸ“¦ Install Dependencies
        working-directory: ./frontend
        run: npm ci

      # 4. æž„å»ºå‰ç«¯
      - name: ðŸ—ï¸ Build Frontend
        working-directory: ./frontend
        run: npm run build

      # 5. ä¸Šä¼ æž„å»ºäº§ç‰©
      - name: ðŸ“¦ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 7

      # 6. éƒ¨ç½²åˆ°æœåŠ¡å™¨
      - name: ðŸš€ Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "================================"
            echo "ðŸš€ å¼€å§‹éƒ¨ç½²å‰ç«¯"
            echo "================================"

            # æ·»åŠ  git å®‰å…¨ç›®å½•
            git config --global --add safe.directory /var/www/sld-diy

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /var/www/sld-diy

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ðŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            git pull origin main

            # æž„å»ºå‰ç«¯
            echo "ðŸ—ï¸ æž„å»ºå‰ç«¯..."
            cd frontend
            npm install
            npm run build

            # å¤åˆ¶ admin åŽå°åˆ° dist/admin (nginxç›´æŽ¥æŒ‡å‘è¿™é‡Œ)
            echo "ðŸ“‹ å¤åˆ¶ admin åŽå°æ–‡ä»¶..."
            if [ -d "../legacy/admin" ]; then
              cp -r ../legacy/admin dist/admin
              echo "âœ… admin ç›®å½•å¤åˆ¶åˆ° dist/admin æˆåŠŸ"
            fi

            # å¤åˆ¶æ•´ä¸ª legacy ç›®å½•
            if [ -d "../legacy" ]; then
              cp -r ../legacy dist/legacy
              echo "âœ… legacy ç›®å½•å¤åˆ¶æˆåŠŸ"
            fi
            cd ..

            # é‡å¯Nginxå®¹å™¨ä»¥åº”ç”¨æ›´æ–°
            echo "ðŸ”„ é‡å¯ Nginx å®¹å™¨..."
            sudo docker compose restart nginx

            # ç­‰å¾…Nginxå¯åŠ¨
            echo "â³ ç­‰å¾… Nginx å¯åŠ¨..."
            sleep 10

            # æ£€æŸ¥NginxçŠ¶æ€
            echo "ðŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            sudo docker compose ps nginx

            echo "================================"
            echo "âœ… å‰ç«¯éƒ¨ç½²æˆåŠŸ"
            echo "================================"

      # 7. å¥åº·æ£€æŸ¥
      - name: ðŸ¥ Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ðŸ¥ å‰ç«¯å¥åº·æ£€æŸ¥..."
            cd /var/www/sld-diy
            
            # æ£€æŸ¥Nginxæ˜¯å¦è¿è¡Œ
            if ! sudo docker compose ps nginx | grep -q "running"; then
              echo "âŒ Nginx å®¹å™¨æœªè¿è¡Œ"
              exit 1
            fi
            
            # æ£€æŸ¥å‰ç«¯é¡µé¢æ˜¯å¦å¯è®¿é—®
            if curl -f -s http://localhost:9000/ > /dev/null; then
              echo "âœ… å‰ç«¯é¡µé¢å¯è®¿é—®"
            else
              echo "âŒ å‰ç«¯é¡µé¢æ— æ³•è®¿é—®"
              exit 1
            fi
            
            # æ£€æŸ¥ç™»å½•é¡µé¢
            if curl -f -s http://localhost:9000/login > /dev/null; then
              echo "âœ… ç™»å½•é¡µé¢å¯è®¿é—®"
            else
              echo "âš ï¸ ç™»å½•é¡µé¢æ— æ³•è®¿é—®"
            fi
            
            echo "âœ… å¥åº·æ£€æŸ¥å®Œæˆ"

      # 8. éƒ¨ç½²é€šçŸ¥
      - name: ðŸ“¢ Deployment Summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "## âœ… å‰ç«¯éƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}:9000" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ æž„å»ºæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### æç¤º" >> $GITHUB_STEP_SUMMARY
            echo "å¦‚æžœçœ‹ä¸åˆ°æ›´æ–°ï¼Œè¯·æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ (Ctrl+Shift+R)" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ å‰ç«¯éƒ¨ç½²å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æŸ¥çœ‹æ—¥å¿—æŽ’æŸ¥é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          fi
